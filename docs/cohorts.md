# Cohorts

Cohorts are spec-defined, reproducible experiment manifests. Every cohort ID maps to a
`data/cohorts/<cohort_id>/spec/` bundle, and Dagster materializes membership exclusively from that
spec. Curated selections refine (but never replace) the spec-defined rows.

See also
- `docs/spec_dsl.md` for the DSL vocabulary and schema.
- `scripts/migrations/generate_cohort_spec.py` for migrating legacy cohorts into specs.

> `membership.csv` is the only authoritative source of cohort members. The
> `origin_cohort_id` stored in gens metadata is provenance only.

## Spec-Driven Workflow

1. **Author or migrate a spec bundle.**
   - Create `data/cohorts/<cohort_id>/spec/config.yaml` and supporting CSV files referenced via
     `@file:` (see _Spec bundle layout_ below).
   - To migrate an existing cohort, run
     ```bash
     uv run python scripts/migrations/generate_cohort_spec.py <cohort_id>
     ```
     This snapshots the current membership into a spec bundle and verifies round-trip stability.

2. **Materialize the cohort assets.**
   - Set `DD_COHORT=<cohort_id>` (or pass `asset_config.override`) so the Dagster run targets the
     intended spec.
   - Build the manifest and membership:
     ```bash
     uv run dagster asset materialize -f src/daydreaming_dagster/definitions.py \
       --select "cohort_id,cohort_membership"
     ```
   - The run validates catalog references, enforces parent integrity, writes
     `data/cohorts/<cohort_id>/manifest.json` and
     `data/cohorts/<cohort_id>/membership.csv`, and registers dynamic partitions add-only for the
     generated `gen_id`s.

3. **Materialize downstream assets.**
   - Use the registered `gen_id` partitions to run draft/essay/evaluation assets or aggregated
     reports as needed:
     ```bash
     uv run dagster asset materialize -f src/daydreaming_dagster/definitions.py \
       --select "draft_prompt,draft_raw,draft_parsed" --partition "<draft_gen_id>"
     ```
     Duplicate the command for essays (`essay_*`) and evaluations (`evaluation_*`) or run aggregate
     assets such as `cohort_aggregated_scores` and `final_results`.

## Spec Bundle Layout

```
data/
  cohorts/
    <cohort_id>/
      spec/
        config.yaml
        items/
          *.csv
```

- `config.yaml` declares axes, couplings, and replication targets. Every catalog reference must be
  explicit; unspecified axes do not fall back to catalog defaults.
- Single-column CSV files referenced via `@file:` provide axis levels. Multi-column CSVs map to tuple
  values in header order (e.g., paired templates and models).
- The runtime loader treats specs as immutable inputs—commit them alongside catalog changes so
  cohorts remain reproducible.

## Curated Selections (Optional Filters)

Curated selection files narrow the spec-defined plan to a subset of existing generations. They are
optional and only apply when the cohort spec already exists.

- Place one of the following files under `data/2_tasks/` before materializing:
  - `selected_essays.txt` — essay `gen_id`s (one per line) to reuse existing essays and rebuild
    evaluations for the spec's evaluation templates/models.
  - `selected_drafts.txt` — draft `gen_id`s to reuse drafts while regenerating essays and evaluations
    according to the spec.
- Only one selection file may be present; asset execution fails fast when both exist.
- When no selection file exists, the entire spec plan is materialized.
- Selection files never inject templates or models—coverage still derives from the spec's evaluation
  axes.

After materialization, remove the selection file if you want the next run to materialize the full
spec again.

## Operational Tips

- **Environment override.** Set `DD_COHORT=<cohort_id>` (or pass `asset_config.override`) so the
  `cohort_id` asset resolves to the correct spec bundle.
- **Analysis.** Include `cohort_id` and `parent_gen_id` when comparing runs to keep pivots stable.
- **Replication config.** `data/1_raw/replication_config.csv` must provide integer replication counts
  for draft, essay, and evaluation stages. The cohort builder fails fast when counts are missing or
  invalid.

## Essay Modes (Copy vs LLM)

Essay templates specify a `generator` column in `data/1_raw/essay_templates.csv`:

- `copy` — the essay is the parsed draft text (single-phase).
- `llm` — the essay is generated by an LLM (two-phase).

Configure the spec to include only the essay templates needed for a cohort. If you want distinct
cohorts for one-phase and two-phase runs, create separate spec bundles so deterministic IDs remain
isolated. See `docs/architecture/architecture.md` (“Two-Phase LLM Generation”) for runtime details.
